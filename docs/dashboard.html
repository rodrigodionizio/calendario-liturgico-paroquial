<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sacristia Digital | Painel de Gestão</title>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Design System: Principal + Dashboard -->
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />

    <!-- Favicon Padrão -->
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <!-- Favicon em Alta Resolução -->
    <link rel="icon" type="image/png" href="assets/img/favicon.ico" />

    <style>
      /* Bloqueio de visibilidade pré-auth (Segurança UX) */
      body {
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      body.auth-ok {
        opacity: 1;
      }

      /* Controle de Abas */
      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body class="admin-body">
    <!-- SIDEBAR: NAVEGAÇÃO MESTRE -->
    <nav class="admin-sidebar">
      <div class="admin-logo">
        <img
          src="assets/img/logo-horizontal-negativa.png"
          alt="Sacristia Digital"
          style="width: 180px"
        />
      </div>

      <div class="menu-item active" data-tab="visao-geral">
        <i data-lucide="layout-dashboard"></i> Visão Geral
      </div>
      <div class="menu-item" data-tab="agenda-total">
        <i data-lucide="calendar"></i> Agenda Paroquial
      </div>
      <div class="menu-item" data-tab="equipes">
        <i data-lucide="users"></i> Gerenciar Equipes
      </div>

      <div class="menu-item" data-tab="comunidades">
        <i data-lucide="church"></i> Gestão de Comunidades
      </div>

      <!-- Este menu só aparecerá via JS para Admins Nível 1 e 2 -->
      <div
        class="menu-item"
        data-tab="usuarios"
        id="menu-usuarios"
        style="display: none"
      >
        <i data-lucide="shield-check"></i> Gestão de Acessos
      </div>

      <a
        href="index.html"
        class="menu-item"
        style="
          border-top: 1px solid rgba(255, 255, 255, 0.15);
          margin-top: 20px;
          opacity: 1;
          background: rgba(251, 181, 88, 0.15);
          transition: all 0.3s;
        "
        onmouseover="this.style.background = 'rgba(251, 181, 88, 0.25)'"
        onmouseout="this.style.background = 'rgba(251, 181, 88, 0.15)'"
      >
        <i data-lucide="globe"></i> Ver Site Público
      </a>

      <div
        class="menu-item"
        onclick="window.api.logout()"
        style="margin-top: auto; color: #ff9999; transition: all 0.3s"
        onmouseover="this.style.background = 'rgba(255,153,153,0.1)'"
        onmouseout="this.style.background = 'transparent'"
      >
        <i data-lucide="log-out"></i> Sair do Sistema
      </div>
    </nav>

    <!-- ÁREA DE CONTEÚDO DINÂMICO -->
    <main class="admin-main">
      <!-- HEADER COM PERFIL -->
      <div class="page-header">
        <h1 class="page-title" id="tab-title-display">Painel de Controle</h1>
        <div style="display: flex; align-items: center; gap: 15px">
          <div style="text-align: right">
            <p
              id="user-name"
              style="
                font-weight: 800;
                color: var(--text-main);
                font-size: 0.85rem;
                margin: 0;
              "
            >
              Rodrigo Dionízio
            </p>
            <p
              style="
                font-size: 0.7rem;
                color: var(--cor-sub);
                font-weight: 700;
                margin: 0;
              "
            >
              Administrador
            </p>
          </div>
          <div
            class="avatar"
            id="user-avatar"
            style="
              width: 45px;
              height: 45px;
              border-radius: 50%;
              background: #eee;
              border: 2px solid var(--cor-vinho);
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: 900;
              color: var(--cor-vinho);
            "
          >
            RD
          </div>
        </div>
      </div>

      <!-- ABA 1: VISÃO GERAL (Métricas e Gráficos) -->
      <section id="tab-visao-geral" class="tab-content active">
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-value" id="kpi-semana">0</div>
            <div class="kpi-label">Eventos na Semana</div>
          </div>
          <div class="kpi-card" style="border-left-color: var(--cor-cereja)">
            <div class="kpi-value" id="kpi-pendentes">0</div>
            <div class="kpi-label">Aguardando Aprovação</div>
          </div>
          <div class="kpi-card" style="border-left-color: #2e7d32">
            <div class="kpi-value" id="kpi-mural">0</div>
            <div class="kpi-label">Avisos no Mural</div>
          </div>
          <div class="kpi-card" style="border-left-color: #2196f3">
            <div class="kpi-value" id="kpi-equipes">0</div>
            <div class="kpi-label">Equipes Ativas</div>
          </div>
        </div>

        <div class="dashboard-split">
          <div class="panel">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
              "
            >
              <div class="panel-title" style="margin: 0">Ritmo Mensal</div>
              <div
                id="chart-total-badge"
                style="
                  font-size: 0.7rem;
                  background: #fff1f2;
                  color: var(--cor-vinho);
                  padding: 4px 10px;
                  border-radius: 12px;
                  font-weight: 800;
                  font-family: var(--font-titulo);
                  letter-spacing: 0.5px;
                "
              >
                Carregando...
              </div>
            </div>
            <div class="chart-container" id="chart-week"></div>
          </div>
          <div class="panel">
            <div class="panel-title">Atividades Recentes</div>
            <div id="admin-event-list">
              <!-- Injetado por DashboardController.renderizarListaRecentes -->
            </div>
          </div>
        </div>
      </section>

      <!-- ABA 2: AGENDA TOTAL (O Calendário de Gestão) -->
      <section id="tab-agenda-total" class="tab-content">
        <div class="panel">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2
              id="admin-calendar-month"
              class="month-name"
              style="color: var(--cor-vinho); margin: 0"
            >
              ...
            </h2>
            
            <!-- Filtro de Comunidades -->
            <div id="dashboard-community-filter-wrapper" style="display: flex; align-items: center; gap: 12px;">
              <label for="dashboard-community-filter" style="font-size: 0.95rem; font-weight: 600; color: var(--cor-vinho); white-space: nowrap;">
                <i data-lucide="map-pin" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;"></i>
                Local:
              </label>
              <select 
                id="dashboard-community-filter" 
                class="sds-select"
                onchange="window.DashboardController.aplicarFiltroComunidade(this.value)"
                style="
                  min-width: 180px;
                  max-width: 280px;
                  padding: 8px 32px 8px 12px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  font-size: 0.95rem;
                  font-weight: 500;
                  background-color: white;
                  background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg width=%2714%27 height=%278%27 viewBox=%270 0 14 8%27 fill=%27none%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M1 1l6 6 6-6%27 stroke=%27%23a41d31%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3e%3c/svg%3e');
                  background-repeat: no-repeat;
                  background-position: right 10px center;
                  cursor: pointer;
                  transition: all 0.2s;
                  appearance: none;
                "
                onfocus="this.style.borderColor='#fbb558'; this.style.boxShadow='0 0 0 3px rgba(251,181,88,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              >
                <option value="">Todas as Comunidades</option>
                <!-- Opções serão preenchidas via JavaScript -->
              </select>
            </div>
            
            <div class="nav-buttons">
              <button
                class="btn-nav"
                onclick="window.DashboardController.navegarAgenda(-1)"
              >
                &lt;
              </button>
              <button
                class="btn-nav"
                onclick="window.DashboardController.navegarAgenda(0)"
              >
                Hoje
              </button>
              <button
                class="btn-nav"
                onclick="window.DashboardController.navegarAgenda(1)"
              >
                &gt;
              </button>
            </div>
          </div>
          <div class="calendar-wrapper" id="admin-calendar-grid">
            <!-- Motor calendar-engine.js atuando aqui -->
          </div>
        </div>
      </section>

      <!-- ABA 3: EQUIPES (CRUD de Pastorais) -->
      <section id="tab-equipes" class="tab-content">
        <!-- Injetado por DashboardController.renderizarAbaEquipes -->
      </section>

      <!-- ABA 4: COMUNIDADES (CRUD de Comunidades e Capelas) -->
      <section id="tab-comunidades" class="tab-content">
        <!-- Injetado por DashboardController.renderizarAbaComunidades -->
      </section>

      <!-- ABA 5: USUÁRIOS (Controle de Acesso) -->
      <section id="tab-usuarios" class="tab-content">
        <!-- Injetado por DashboardController.renderizarAbaUsuarios -->
      </section>
    </main>

    <!-- MODAL DE EDIÇÃO / GESTÃO -->
    <div
      class="modal-overlay"
      id="modalOverlay"
      onclick="if (event.target == this) this.classList.remove('active');"
    >
      <div id="modalContent"></div>
    </div>

    <!-- SCRIPTS MESTRES (Ordem Crítica) -->
    <script src="assets/js/api.js"></script>
    <script src="assets/js/calendar-engine.js"></script>
    <script src="assets/js/dashboard.js"></script>
    <script>
      // Ativa os ícones após tudo carregar
      document.addEventListener("DOMContentLoaded", () => {
        if (window.lucide) lucide.createIcons();
      });
    </script>
  </body>
</html>
